<script type="text/javascript">
  RED.nodes.registerType('nats-suite-publish', {
    category: 'NATS Suite',
    color: '#2FAF9C',
    defaults: {
      name: { value: '' },
      server: { value: '', type: 'nats-suite-server' },
      debug: { value: false },
      enableBuffer: { value: false },
      mode: { value: 'publish' }, // 'publish', 'reply', 'request'
      bufferSize: { value: 1000 },
      bufferSizeType: { value: 'count' },
      bufferSizeBytes: { value: 10485760 },
      bufferMode: { value: 'drop-oldest' },
      bufferPersistence: { value: 'none' },
      bufferAutoSaveInterval: { value: 30 },
      message: { value: '' },
      dataformat: { value: 'json', required: true },
      datapointid: { value: '' },
      enableTopicOverride: { value: false },
      enableBatch: { value: false },
      batchSize: { value: 100 },
      batchInterval: { value: 1000 },
      batchMode: { value: 'hybrid' },
      requestTimeout: { value: 5000 },
      enableAutoReply: { value: false },
      replyTimeout: { value: 5000 },
      enableRateLimit: { value: false },
      rateLimit: { value: 100 },
      rateLimitWindow: { value: 1000 },
      rateLimitBurst: { value: 20 },
      rateLimitAction: { value: 'drop' },
      enableHeaders: { value: false },
      headers: { value: '' },
      enableMsgExpiration: { value: false },
      msgExpiration: { value: 0 },
      outputs: { value: 0 }
    },
    inputs: 1,
    outputs: 0,
    icon: 'nats-icon-white.png',
    align: 'right',
    label: function () {
      return this.name || 'nats publish';
    },
    paletteLabel: 'nats publish',
    oneditprepare: function() {
      // Collapsible sections
      $('.nats-section-header').on('click', function() {
        const $header = $(this);
        const $content = $header.next('.nats-section-content');
        const $icon = $header.find('.nats-section-toggle');
        
        $content.slideToggle(200);
        $icon.toggleClass('fa-chevron-down fa-chevron-right');
        $header.toggleClass('collapsed');
      });
      
      // Buffer configuration
      $('#node-input-enableBuffer').on('change', function() {
        if ($(this).is(':checked')) {
          $('#buffer-options').slideDown(200);
          $('#node-input-bufferSizeType').trigger('change');
          $('#node-input-bufferPersistence').trigger('change');
        } else {
          $('#buffer-options').slideUp(200);
        }
      });
      
      $('#node-input-bufferPersistence').on('change', function() {
        if ($(this).val() === 'none') {
          $('#buffer-autosave-row').hide();
        } else {
          $('#buffer-autosave-row').show();
        }
      });
      
      $('#node-input-bufferSizeType').on('change', function() {
        if ($(this).val() === 'count') {
          $('#buffer-size-count-row').show();
          $('#buffer-size-bytes-row').hide();
        } else {
          $('#buffer-size-count-row').hide();
          $('#buffer-size-bytes-row').show();
        }
      });
      
      // Batch configuration
      $('#node-input-enableBatch').on('change', function() {
        if ($(this).is(':checked')) {
          $('#batch-options').slideDown(200);
        } else {
          $('#batch-options').slideUp(200);
        }
      });
      
      // Auto-Reply configuration
      $('#node-input-enableAutoReply').on('change', function() {
        if ($(this).is(':checked')) {
          $('#autoreply-options').slideDown(200);
        } else {
          $('#autoreply-options').slideUp(200);
        }
      });
      
      // Rate Limit configuration
      $('#node-input-enableRateLimit').on('change', function() {
        if ($(this).is(':checked')) {
          $('#ratelimit-options').slideDown(200);
        } else {
          $('#ratelimit-options').slideUp(200);
        }
      });
      
      // Headers configuration
      $('#node-input-enableHeaders').on('change', function() {
        if ($(this).is(':checked')) {
          $('#headers-options').slideDown(200);
        } else {
          $('#headers-options').slideUp(200);
        }
      });
      
      // Message Expiration configuration
      $('#node-input-enableMsgExpiration').on('change', function() {
        if ($(this).is(':checked')) {
          $('#expiration-options').slideDown(200);
        } else {
          $('#expiration-options').slideUp(200);
        }
      });
      
      // Mode configuration - affects outputs and visibility
      $('#node-input-mode').on('change', function() {
        const mode = $(this).val();
        
        // Show/hide request timeout section
        if (mode === 'request') {
          $('#requestreply-options').slideDown(200);
        } else {
          $('#requestreply-options').slideUp(200);
        }
        
        // Show/hide subject field and topic override (hidden in reply mode as it comes from msg._reply)
        if (mode === 'reply') {
          $('#subject-row').slideUp(200);
          $('#topic-override-row').slideUp(200);
        } else {
          $('#subject-row').slideDown(200);
          $('#topic-override-row').slideDown(200);
        }
      });
      
      // Set defaults
      if (!this.bufferMode) $('#node-input-bufferMode').val('drop-oldest');
      if (!this.batchMode) $('#node-input-batchMode').val('hybrid');
      
      // Initialize outputs based on current mode
      const currentMode = this.mode || 'publish';
      this.outputs = (currentMode === 'request') ? 1 : 0;
      
      // Trigger initial state
      $('#node-input-mode').trigger('change');
      $('#node-input-enableBuffer').trigger('change');
      $('#node-input-enableBatch').trigger('change');
      $('#node-input-enableAutoReply').trigger('change');
      $('#node-input-enableRateLimit').trigger('change');
      $('#node-input-enableHeaders').trigger('change');
      $('#node-input-enableMsgExpiration').trigger('change');
    },

    oneditsave: function() {
      const mode = $('#node-input-mode').val();
      
      // Set the number of outputs based on the subscription mode
      if (mode === 'publish'|| mode === 'reply') {
        this.outputs = 0;
      } else {
        this.outputs = 1;
      }
    }
  });
</script>

<script type="text/x-red" data-template-name="nats-suite-publish">
  <style>
    .nats-publish-config {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    
    .nats-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
      border: 1px solid #e1e4e8;
      border-radius: 8px;
      margin-bottom: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    
    .nats-section-header {
      background: linear-gradient(135deg, #f1f3f5 0%, #e9ecef 100%);
      padding: 10px 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e1e4e8;
      transition: background 0.2s ease;
      user-select: none;
    }
    
    .nats-section-header:hover {
      background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    }
    
    .nats-section-header.collapsed {
      border-bottom: none;
    }
    
    .nats-section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 13px;
      color: #2c3e50;
    }
    
    .nats-section-title i {
      width: 18px;
      text-align: center;
      color: #2FAF9C;
      font-size: 14px;
    }
    
    .nats-section-toggle {
      color: #6c757d;
      font-size: 11px;
      transition: transform 0.2s ease;
    }
    
    .nats-section-content {
      padding: 14px;
    }
    
    .nats-form-row {
      margin-bottom: 12px;
    }
    
    .nats-form-row:last-child {
      margin-bottom: 0;
    }
    
    .nats-form-row label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: #495057;
      margin-bottom: 5px;
    }
    
    .nats-form-row label i {
      margin-right: 6px;
      color: #2FAF9C;
      width: 14px;
      text-align: center;
    }
    
    .nats-form-row input[type="text"],
    .nats-form-row input[type="number"],
    .nats-form-row select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 13px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background: #fff;
    }
    
    .nats-form-row input:focus,
    .nats-form-row select:focus {
      border-color: #2FAF9C;
      box-shadow: 0 0 0 3px rgba(47, 175, 156, 0.15);
      outline: none;
    }
    
    .nats-form-row input[type="number"] {
      width: 120px;
    }
    
    .nats-hint {
      font-size: 11px;
      color: #6c757d;
      margin-top: 4px;
      line-height: 1.4;
    }
    
    .nats-unit {
      font-size: 12px;
      color: #6c757d;
      margin-left: 8px;
    }
    
    .nats-checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
    }
    
    .nats-checkbox-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #2FAF9C;
      cursor: pointer;
    }
    
    .nats-checkbox-row label {
      margin: 0;
      font-size: 13px;
      font-weight: 500;
      color: #2c3e50;
      cursor: pointer;
    }
    
    .nats-checkbox-row label i {
      margin-right: 8px;
      color: #2FAF9C;
    }
    
    .nats-options {
      display: none;
      padding-top: 12px;
      border-top: 1px dashed #dee2e6;
      margin-top: 8px;
    }
    
    .nats-inline-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .nats-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .nats-badge-optional {
      background: #e9ecef;
      color: #6c757d;
    }
    
    .nats-badge-dynamic {
      background: #d4edda;
      color: #155724;
    }
    
    .nats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    @media (max-width: 500px) {
      .nats-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .nats-divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, #dee2e6, transparent);
      margin: 16px 0;
    }
    
    .nats-feature-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      background: linear-gradient(135deg, #2FAF9C 0%, #3CC9AD 100%);
      color: white;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
  </style>

  <div class="nats-publish-config">
    
    <!-- Basic Configuration -->
    <div class="nats-section">
      <div class="nats-section-header">
        <div class="nats-section-title">
          <i class="fa fa-cog"></i>
          <span>Basic Configuration</span>
        </div>
        <i class="fa fa-chevron-down nats-section-toggle"></i>
      </div>
      <div class="nats-section-content">
        <div class="nats-form-row">
          <label><i class="fa fa-tag"></i>Name</label>
          <input type="text" id="node-input-name" placeholder="Optional display name">
        </div>
        
        <div class="nats-form-row">
          <label><i class="fa fa-server"></i>NATS Server</label>
          <input type="text" id="node-input-server">
        </div>
        
        <div class="nats-checkbox-row">
          <input type="checkbox" id="node-input-debug">
          <label for="node-input-debug"><i class="fa fa-bug"></i>Enable Debug Logging</label>
        </div>
      </div>
    </div>
    
    <!-- Message Configuration -->
    <div class="nats-section">
      <div class="nats-section-header">
        <div class="nats-section-title">
          <i class="fa fa-envelope"></i>
          <span>Message Configuration</span>
        </div>
        <i class="fa fa-chevron-down nats-section-toggle"></i>
      </div>
      <div class="nats-section-content">

        <div class="nats-form-row">
          <label><i class="fa fa-file-code-o"></i>Mode</label>
          <select id="node-input-mode">
            <option value="publish">Publish</option>
            <option value="reply">Reply</option>
            <option value="request">Request</option>
          </select>
        </div>

        <div class="nats-form-row" id="subject-row">
          <label><i class="fa fa-exchange"></i>NATS Subject</label>
          <input type="text" id="node-input-datapointid" placeholder="e.g. sensor.temperature">
        </div>

        <div class="nats-checkbox-row" id="topic-override-row">
          <input type="checkbox" id="node-input-enableTopicOverride">
          <label for="node-input-enableTopicOverride"><i class="fa fa-exchange"></i>Allow msg.topic to override subject</label>
        </div>
        
        <div class="nats-form-row">
          <label><i class="fa fa-file-code-o"></i>Data Format</label>
          <select id="node-input-dataformat">
            <option value="json">JSON (auto-stringify objects)</option>
            <option value="string">String (as-is)</option>
            <option value="buffer">Buffer (binary data)</option>
          </select>
        </div>
        
        <!-- Request Timeout (shown when mode is 'request') -->
        <div id="requestreply-options" class="nats-options">
          <div class="nats-form-row">
            <label><i class="fa fa-hourglass-half"></i>Request Timeout</label>
            <div class="nats-inline-row">
              <input type="number" id="node-input-requestTimeout" placeholder="5000" min="100" max="60000">
              <span class="nats-unit">ms</span>
            </div>
            <div class="nats-hint">
              Sends request and waits for reply. Reply appears at output.<br>
              On timeout: <code>msg.error</code> is set with timeout info.
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Advanced Features -->
    <div class="nats-section">
      <div class="nats-section-header">
        <div class="nats-section-title">
          <i class="fa fa-magic"></i>
          <span>Advanced Features</span>
        </div>
        <i class="fa fa-chevron-down nats-section-toggle"></i>
      </div>
      <div class="nats-section-content">
        
        <!-- Headers -->
        <div class="nats-checkbox-row">
          <input type="checkbox" id="node-input-enableHeaders">
          <label for="node-input-enableHeaders"><i class="fa fa-tags"></i>Message Headers</label>
          <span class="nats-badge nats-badge-dynamic">msg.headers</span>
        </div>
        <div id="headers-options" class="nats-options">
          <div class="nats-form-row">
            <label><i class="fa fa-code"></i>Static Headers (JSON) <span class="nats-badge nats-badge-optional">optional</span></label>
            <input type="text" id="node-input-headers" placeholder='{"X-App": "MyApp", "X-Priority": "high"}'>
            <div class="nats-hint">
              Static headers merged with dynamic <code>msg.headers</code> at runtime
            </div>
          </div>
        </div>
        
        <div class="nats-divider"></div>
        
        <!-- Message Expiration -->
        <div class="nats-checkbox-row">
          <input type="checkbox" id="node-input-enableMsgExpiration">
          <label for="node-input-enableMsgExpiration"><i class="fa fa-clock-o"></i>Message Expiration (TTL)</label>
          <span class="nats-badge nats-badge-dynamic">msg.expiration</span>
        </div>
        <div id="expiration-options" class="nats-options">
          <div class="nats-form-row">
            <label><i class="fa fa-hourglass-end"></i>Expiration Time</label>
            <div class="nats-inline-row">
              <input type="number" id="node-input-msgExpiration" placeholder="0" min="0" max="86400">
              <span class="nats-unit">seconds</span>
            </div>
            <div class="nats-hint">
              Messages expire if not consumed within this time. Requires JetStream.
            </div>
          </div>
        </div>
        
      </div>
    </div>
    
    <!-- Performance & Reliability -->
    <div class="nats-section">
      <div class="nats-section-header">
        <div class="nats-section-title">
          <i class="fa fa-tachometer"></i>
          <span>Performance & Reliability</span>
        </div>
        <i class="fa fa-chevron-down nats-section-toggle"></i>
      </div>
      <div class="nats-section-content">
        
        <!-- Message Buffering -->
        <div class="nats-checkbox-row">
          <input type="checkbox" id="node-input-enableBuffer">
          <label for="node-input-enableBuffer"><i class="fa fa-database"></i>Message Buffering</label>
        </div>
        <div class="nats-hint" style="margin-left: 24px; margin-bottom: 8px;">
          Queue messages when disconnected, publish when reconnected
        </div>
        <div id="buffer-options" class="nats-options">
          <div class="nats-grid">
            <div class="nats-form-row">
              <label><i class="fa fa-sliders"></i>Limit Type</label>
              <select id="node-input-bufferSizeType">
                <option value="count">Message Count</option>
                <option value="size">Buffer Size (Bytes)</option>
              </select>
            </div>
            
            <div class="nats-form-row" id="buffer-size-count-row">
              <label><i class="fa fa-list"></i>Max Messages</label>
              <div class="nats-inline-row">
                <input type="number" id="node-input-bufferSize" placeholder="1000" min="10" max="10000">
                <span class="nats-unit">msgs</span>
              </div>
            </div>
            
            <div class="nats-form-row" id="buffer-size-bytes-row" style="display: none;">
              <label><i class="fa fa-hdd-o"></i>Max Size</label>
              <div class="nats-inline-row">
                <input type="number" id="node-input-bufferSizeBytes" placeholder="10485760" min="1024">
                <span class="nats-unit">bytes</span>
              </div>
            </div>
            
            <div class="nats-form-row">
              <label><i class="fa fa-exchange"></i>Overflow Mode</label>
              <select id="node-input-bufferMode">
                <option value="drop-oldest">Drop Oldest (FIFO)</option>
                <option value="drop-newest">Drop Newest</option>
                <option value="drop-on-full">Reject on Full</option>
              </select>
            </div>
          </div>
          
          <div class="nats-divider"></div>
          
          <div class="nats-grid">
            <div class="nats-form-row">
              <label><i class="fa fa-floppy-o"></i>Persistence</label>
              <select id="node-input-bufferPersistence">
                <option value="none">None (RAM only)</option>
                <option value="context">Context Storage</option>
                <option value="file">File System</option>
                <option value="both">Both (Max Safety)</option>
              </select>
            </div>
            
            <div class="nats-form-row" id="buffer-autosave-row" style="display: none;">
              <label><i class="fa fa-save"></i>Auto-Save</label>
              <div class="nats-inline-row">
                <input type="number" id="node-input-bufferAutoSaveInterval" placeholder="30" min="5" max="300">
                <span class="nats-unit">sec</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="nats-divider"></div>
        
        <!-- Batch Publishing -->
        <div class="nats-checkbox-row">
          <input type="checkbox" id="node-input-enableBatch">
          <label for="node-input-enableBatch"><i class="fa fa-th-large"></i>Batch Publishing</label>
        </div>
        <div class="nats-hint" style="margin-left: 24px; margin-bottom: 8px;">
          Group messages for more efficient publishing
        </div>
        <div id="batch-options" class="nats-options">
          <div class="nats-grid">
            <div class="nats-form-row">
              <label><i class="fa fa-list-ol"></i>Batch Size</label>
              <div class="nats-inline-row">
                <input type="number" id="node-input-batchSize" placeholder="100" min="1" max="1000">
                <span class="nats-unit">msgs</span>
              </div>
            </div>
            
            <div class="nats-form-row">
              <label><i class="fa fa-clock-o"></i>Interval</label>
              <div class="nats-inline-row">
                <input type="number" id="node-input-batchInterval" placeholder="1000" min="100" max="60000">
                <span class="nats-unit">ms</span>
              </div>
            </div>
          </div>
          
          <div class="nats-form-row">
            <label><i class="fa fa-gears"></i>Batch Mode</label>
            <select id="node-input-batchMode">
              <option value="hybrid">Hybrid (Size OR Time)</option>
              <option value="size">Size Only</option>
              <option value="time">Time Only</option>
            </select>
            <div class="nats-hint">
              Hybrid: Publish when batch size OR interval reached (whichever first)
            </div>
          </div>
        </div>
        
        <div class="nats-divider"></div>
        
        <!-- Rate Limiting -->
        <div class="nats-checkbox-row">
          <input type="checkbox" id="node-input-enableRateLimit">
          <label for="node-input-enableRateLimit"><i class="fa fa-shield"></i>Rate Limiting</label>
        </div>
        <div class="nats-hint" style="margin-left: 24px; margin-bottom: 8px;">
          Prevent message flooding with throughput limits
        </div>
        <div id="ratelimit-options" class="nats-options">
          <div class="nats-grid">
            <div class="nats-form-row">
              <label><i class="fa fa-line-chart"></i>Rate Limit</label>
              <div class="nats-inline-row">
                <input type="number" id="node-input-rateLimit" placeholder="100" min="1" max="10000">
                <span class="nats-unit">msgs/window</span>
              </div>
            </div>
            
            <div class="nats-form-row">
              <label><i class="fa fa-clock-o"></i>Time Window</label>
              <div class="nats-inline-row">
                <input type="number" id="node-input-rateLimitWindow" placeholder="1000" min="100" max="60000">
                <span class="nats-unit">ms</span>
              </div>
            </div>
            
            <div class="nats-form-row">
              <label><i class="fa fa-bolt"></i>Burst Allowance</label>
              <div class="nats-inline-row">
                <input type="number" id="node-input-rateLimitBurst" placeholder="20" min="0" max="1000">
                <span class="nats-unit">extra</span>
              </div>
            </div>
            
            <div class="nats-form-row">
              <label><i class="fa fa-exclamation-triangle"></i>On Limit</label>
              <select id="node-input-rateLimitAction">
                <option value="drop">Drop (Silent)</option>
                <option value="drop-warn">Drop + Warning</option>
                <option value="delay">Delay (Queue)</option>
              </select>
            </div>
          </div>
        </div>
        
      </div>
    </div>
    
  </div>
</script>

<script type="text/x-red" data-help-name="nats-suite-publish">
  <p>Publishes messages to NATS subjects with advanced features.</p>

  <h3>Inputs</h3>
  <dl class="message-properties">
    <dt>payload <span class="property-type">any</span></dt>
    <dd>The data to publish. Format depends on the selected data format.</dd>
    
    <dt class="optional">topic <span class="property-type">string</span></dt>
    <dd>Override the configured NATS subject (only if "Allow msg.topic to override subject" is enabled in publish/request modes).</dd>
    
    <dt class="optional">headers <span class="property-type">object</span></dt>
    <dd>Dynamic NATS headers to include with the message.</dd>
    
    <dt class="optional">expiration <span class="property-type">number</span></dt>
    <dd>Message TTL in seconds (requires JetStream).</dd>
  </dl>

  <h3>Data Formats</h3>
  <ul>
    <li><strong>JSON:</strong> Automatically stringifies objects</li>
    <li><strong>String:</strong> Sends payload as-is</li>
    <li><strong>Buffer:</strong> Binary data support</li>
    <li><strong>Reply:</strong> For request-reply patterns using <code>msg._reply</code></li>
  </ul>

  <h3>Features</h3>
  
  <h4>Message Headers</h4>
  <p>Add custom NATS headers to messages. Static headers configured in the node are merged with dynamic headers from <code>msg.headers</code>.</p>
  <pre>msg.headers = {
  "X-User": "john",
  "X-Request-ID": "abc123"
};</pre>

  <h4>Message Buffering</h4>
  <p>Queues messages when disconnected from NATS and automatically publishes them when reconnected. Supports persistence to survive Node-RED restarts.</p>

  <h4>Batch Publishing</h4>
  <p>Groups multiple messages together for more efficient publishing. Supports size-based, time-based, or hybrid triggering.</p>

  <h4>Rate Limiting</h4>
  <p>Prevents message flooding using a token bucket algorithm. Configurable rate, time window, and burst allowance.</p>

  <h4>Request-Reply Mode (Client Side)</h4>
  <p>Enables the NATS request-reply pattern. The node sends a request to the configured subject and waits for a reply.</p>
  <ul>
    <li>Automatically generates a unique inbox subject for the reply</li>
    <li>Waits for response up to the configured timeout</li>
    <li>Reply message appears at the node output</li>
    <li>On timeout: <code>msg.error</code> contains timeout information</li>
  </ul>
  <pre>// Input
msg.payload = { action: "getData", id: 123 };
msg.topic = "my.service";

// Output (on success)
msg.payload = { result: "data..." };
msg.requestTime = 45; // ms

// Output (on timeout)
msg.error = { message: "Request timeout", code: "TIMEOUT" };</pre>

  <h4>Auto-Reply Handler (Service Side)</h4>
  <p>For building services: Forwards input to output for processing, then sends the returned payload as a reply to <code>msg.replyTo</code>.</p>

  <h3>Subject Wildcards</h3>
  <ul>
    <li><code>*</code> - matches a single token (e.g., <code>sensor.*.temperature</code>)</li>
    <li><code>&gt;</code> - matches one or more tokens (e.g., <code>sensor.&gt;</code>)</li>
  </ul>
</script>
