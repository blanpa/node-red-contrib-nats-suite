<script type="text/javascript">
  RED.nodes.registerType('nats-suite-server-manager', {
    category: 'NATS Suite',
    color: '#2FAF9C',
    defaults: {
      name: { value: "" },
      serverType: { value: "embedded", required: true },
      port: { value: 4222, required: true, validate: function(val) { return /^\d+$/.test(val) && parseInt(val) > 0 && parseInt(val) < 65536; } },
      leafPort: { value: 7422, required: true, validate: function(val) { return /^\d+$/.test(val) && parseInt(val) > 0 && parseInt(val) < 65536; } },
      enableJetStream: { value: false },
      storeDir: { value: "" },
      leafRemoteUrl: { value: "" },
      leafRemoteUser: { value: "" },
      leafRemotePass: { value: "" },
      autoStart: { value: true },
      debug: { value: false }
    },
    inputs: 1,
    outputs: 1,
    icon: "nats-icon-white.png",
    align: "left",
    label: function() {
      return this.name || "nats server manager";
    },
    paletteLabel: 'nats server manager',
    oneditprepare: function() {
      // Collapsible sections
      $('.nats-section-header').on('click', function() {
        const $header = $(this);
        const $content = $header.next('.nats-section-content');
        const $icon = $header.find('.nats-section-toggle');
        $content.slideToggle(200);
        $icon.toggleClass('fa-chevron-down fa-chevron-right');
        $header.toggleClass('collapsed');
      });
      
      // Server type handler
      $('#node-input-serverType').on('change', function() {
        const type = $(this).val();
        if (type === 'leaf') {
          $('#port-row').slideUp(200);
          $('#leaf-config').slideDown(200);
        } else {
          $('#port-row').slideDown(200);
          $('#leaf-config').slideUp(200);
        }
      });
      
      // JetStream handler
      $('#node-input-enableJetStream').on('change', function() {
        if ($(this).is(':checked')) {
          $('#store-dir-row').slideDown(200);
        } else {
          $('#store-dir-row').slideUp(200);
        }
      });
      
      $('#node-input-serverType').trigger('change');
      $('#node-input-enableJetStream').trigger('change');
    }
  });
</script>

<script type="text/html" data-template-name="nats-suite-server-manager">
  <style>
    .nats-manager-config {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    .nats-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
      border: 1px solid #e1e4e8;
      border-radius: 8px;
      margin-bottom: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    .nats-section-header {
      background: linear-gradient(135deg, #f1f3f5 0%, #e9ecef 100%);
      padding: 10px 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e1e4e8;
      transition: background 0.2s ease;
      user-select: none;
    }
    .nats-section-header:hover {
      background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    }
    .nats-section-header.collapsed { border-bottom: none; }
    .nats-section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 13px;
      color: #2c3e50;
    }
    .nats-section-title i {
      width: 18px;
      text-align: center;
      color: #2FAF9C;
      font-size: 14px;
    }
    .nats-section-toggle {
      color: #6c757d;
      font-size: 11px;
    }
    .nats-section-content { padding: 14px; }
    .nats-form-row { margin-bottom: 12px; }
    .nats-form-row:last-child { margin-bottom: 0; }
    .nats-form-row label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: #495057;
      margin-bottom: 5px;
    }
    .nats-form-row label i {
      margin-right: 6px;
      color: #2FAF9C;
      width: 14px;
      text-align: center;
    }
    .nats-form-row input[type="text"],
    .nats-form-row input[type="number"],
    .nats-form-row input[type="password"],
    .nats-form-row select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 13px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background: #fff;
    }
    .nats-form-row input:focus,
    .nats-form-row select:focus {
      border-color: #2FAF9C;
      box-shadow: 0 0 0 3px rgba(47, 175, 156, 0.15);
      outline: none;
    }
    .nats-form-row input[type="number"] { width: 120px; }
    .nats-hint {
      font-size: 11px;
      color: #6c757d;
      margin-top: 4px;
    }
    .nats-checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
    }
    .nats-checkbox-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #2FAF9C;
      cursor: pointer;
    }
    .nats-checkbox-row label {
      margin: 0;
      font-size: 13px;
      font-weight: 500;
      color: #2c3e50;
      cursor: pointer;
    }
    .nats-checkbox-row label i {
      margin-right: 8px;
      color: #2FAF9C;
    }
    .nats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
  </style>

  <div class="nats-manager-config">
    
    <!-- Basic Configuration -->
    <div class="nats-section">
      <div class="nats-section-header">
        <div class="nats-section-title">
          <i class="fa fa-cog"></i>
          <span>Basic Configuration</span>
        </div>
        <i class="fa fa-chevron-down nats-section-toggle"></i>
      </div>
      <div class="nats-section-content">
        <div class="nats-form-row">
          <label><i class="fa fa-tag"></i>Name</label>
          <input type="text" id="node-input-name" placeholder="Optional display name">
        </div>
        <div class="nats-form-row">
          <label><i class="fa fa-server"></i>Server Type</label>
          <select id="node-input-serverType">
            <option value="embedded">Embedded (nats-memory-server)</option>
            <option value="nats-server">NATS Server Process</option>
            <option value="leaf">Leaf Node Server</option>
          </select>
        </div>
        <div class="nats-form-row" id="port-row">
          <label><i class="fa fa-plug"></i>Port</label>
          <input type="number" id="node-input-port" placeholder="4222" min="1" max="65535">
        </div>
      </div>
    </div>
    
    <!-- Leaf Node Config -->
    <div id="leaf-config" style="display: none;">
      <div class="nats-section">
        <div class="nats-section-header">
          <div class="nats-section-title">
            <i class="fa fa-leaf"></i>
            <span>Leaf Node Configuration</span>
          </div>
          <i class="fa fa-chevron-down nats-section-toggle"></i>
        </div>
        <div class="nats-section-content">
          <div class="nats-form-row">
            <label><i class="fa fa-plug"></i>Leaf Node Port</label>
            <input type="number" id="node-input-leafPort" placeholder="7422" min="1" max="65535">
          </div>
          <div class="nats-form-row">
            <label><i class="fa fa-link"></i>Remote NATS Server URL</label>
            <input type="text" id="node-input-leafRemoteUrl" placeholder="nats://remote-server:4222">
          </div>
          <div class="nats-grid">
            <div class="nats-form-row">
              <label><i class="fa fa-user"></i>Remote Username</label>
              <input type="text" id="node-input-leafRemoteUser" placeholder="Optional">
            </div>
            <div class="nats-form-row">
              <label><i class="fa fa-lock"></i>Remote Password</label>
              <input type="password" id="node-input-leafRemotePass" placeholder="Optional">
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- JetStream & Options -->
    <div class="nats-section">
      <div class="nats-section-header">
        <div class="nats-section-title">
          <i class="fa fa-sliders"></i>
          <span>Options</span>
        </div>
        <i class="fa fa-chevron-down nats-section-toggle"></i>
      </div>
      <div class="nats-section-content">
        <div class="nats-checkbox-row">
          <input type="checkbox" id="node-input-enableJetStream">
          <label for="node-input-enableJetStream"><i class="fa fa-database"></i>Enable JetStream</label>
        </div>
        <div class="nats-form-row" id="store-dir-row" style="display: none;">
          <label><i class="fa fa-folder"></i>JetStream Store Directory</label>
          <input type="text" id="node-input-storeDir" placeholder="/tmp/nats-jetstream">
        </div>
        <div class="nats-checkbox-row">
          <input type="checkbox" id="node-input-autoStart" checked>
          <label for="node-input-autoStart"><i class="fa fa-play"></i>Auto-Start on Deploy</label>
        </div>
        <div class="nats-checkbox-row">
          <input type="checkbox" id="node-input-debug">
          <label for="node-input-debug"><i class="fa fa-bug"></i>Enable Debug Logging</label>
        </div>
      </div>
    </div>
    
  </div>
</script>

<script type="text/html" data-help-name="nats-suite-server-manager">
  <p>Starts and manages a NATS server from Node-RED.</p>

  <h3>Server Types</h3>
  <ul>
    <li><strong>Embedded:</strong> In-memory server for testing</li>
    <li><strong>NATS Server:</strong> External nats-server process</li>
    <li><strong>Leaf Node:</strong> Connect to remote cluster</li>
  </ul>

  <h3>Control Commands</h3>
  <pre>msg.payload.command = "start"   // Start server
msg.payload.command = "stop"    // Stop server
msg.payload.command = "restart" // Restart
msg.payload.command = "status"  // Get status</pre>

  <h3>Outputs</h3>
  <dl class="message-properties">
    <dt>topic <span class="property-type">string</span></dt>
    <dd>"server.started", "server.stopped", "server.status"</dd>
    <dt>payload <span class="property-type">object</span></dt>
    <dd>Server details (port, URL, PID)</dd>
  </dl>
</script>
