<script type="text/javascript">
  RED.nodes.registerType('nats-suite-server', {
    category: 'config',
    icon: 'nats-icon-white.png',
    defaults: {
      server: { value: "", required: false },
      authMethod: { value: "none" },
      enableTLS: { value: false },
      tlsRejectUnauthorized: { value: true },
      tlsCaFile: { value: "" },
      tlsCertFile: { value: "" },
      tlsKeyFile: { value: "" },
      maxReconnectAttempts: { value: 10 },
      reconnectTimeWait: { value: 1000 },
      timeout: { value: 10000 },
      pingInterval: { value: 30000 },
      maxPingOut: { value: 3 },
      debug: { value: false }
    },
    credentials: {
      user: { type: "text" },
      pass: { type: "password" },
      token: { type: "password" },
      jwt: { type: "password" },
      nkeySeed: { type: "password" }
    },
    label: function () {
      return this.server || "NATS Server";
    },
    paletteLabel: 'nats server',
    oneditprepare: function() {
      // Collapsible sections
      $('.nats-section-header').on('click', function() {
        const $header = $(this);
        const $content = $header.next('.nats-section-content');
        const $icon = $header.find('.nats-section-toggle');
        $content.slideToggle(200);
        $icon.toggleClass('fa-chevron-down fa-chevron-right');
        $header.toggleClass('collapsed');
      });
      
      // Auth method handler
      const updateAuthFields = () => {
        const authMethod = $('#node-config-input-authMethod').val();
        $('#auth-userpass-section, #auth-token-section, #auth-jwt-section, #auth-nkey-section').hide();
        switch(authMethod) {
          case 'userpass': $('#auth-userpass-section').slideDown(200); break;
          case 'token': $('#auth-token-section').slideDown(200); break;
          case 'jwt': $('#auth-jwt-section').slideDown(200); break;
          case 'nkey': $('#auth-nkey-section').slideDown(200); break;
        }
      };
      
      // TLS handler
      const updateTLSFields = () => {
        if ($('#node-config-input-enableTLS').is(':checked')) {
          $('#tls-config-section').slideDown(200);
        } else {
          $('#tls-config-section').slideUp(200);
        }
      };
      
      updateAuthFields();
      updateTLSFields();
      
      $('#node-config-input-authMethod').on('change', updateAuthFields);
      $('#node-config-input-enableTLS').on('change', updateTLSFields);
    }
  });
</script>

<script type="text/x-red" data-template-name="nats-suite-server">
  <style>
    .nats-server-config {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    .nats-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
      border: 1px solid #e1e4e8;
      border-radius: 8px;
      margin-bottom: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    .nats-section-header {
      background: linear-gradient(135deg, #f1f3f5 0%, #e9ecef 100%);
      padding: 10px 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e1e4e8;
      transition: background 0.2s ease;
      user-select: none;
    }
    .nats-section-header:hover {
      background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    }
    .nats-section-header.collapsed { border-bottom: none; }
    .nats-section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 13px;
      color: #2c3e50;
    }
    .nats-section-title i {
      width: 18px;
      text-align: center;
      color: #2FAF9C;
      font-size: 14px;
    }
    .nats-section-toggle {
      color: #6c757d;
      font-size: 11px;
    }
    .nats-section-content { padding: 14px; }
    .nats-form-row { margin-bottom: 12px; }
    .nats-form-row:last-child { margin-bottom: 0; }
    .nats-form-row label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: #495057;
      margin-bottom: 5px;
    }
    .nats-form-row label i {
      margin-right: 6px;
      color: #2FAF9C;
      width: 14px;
      text-align: center;
    }
    .nats-form-row input[type="text"],
    .nats-form-row input[type="password"],
    .nats-form-row input[type="number"],
    .nats-form-row select,
    .nats-form-row textarea {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 13px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background: #fff;
    }
    .nats-form-row input:focus,
    .nats-form-row select:focus,
    .nats-form-row textarea:focus {
      border-color: #2FAF9C;
      box-shadow: 0 0 0 3px rgba(47, 175, 156, 0.15);
      outline: none;
    }
    .nats-form-row input[type="number"] { width: 120px; }
    .nats-form-row textarea {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 11px;
      resize: vertical;
    }
    .nats-hint {
      font-size: 11px;
      color: #6c757d;
      margin-top: 4px;
      line-height: 1.4;
    }
    .nats-checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
    }
    .nats-checkbox-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #2FAF9C;
      cursor: pointer;
    }
    .nats-checkbox-row label {
      margin: 0;
      font-size: 13px;
      font-weight: 500;
      color: #2c3e50;
      cursor: pointer;
    }
    .nats-checkbox-row label i {
      margin-right: 8px;
      color: #2FAF9C;
    }
    .nats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .nats-auth-section {
      display: none;
      padding-top: 12px;
      border-top: 1px dashed #dee2e6;
      margin-top: 8px;
    }
    .nats-unit {
      font-size: 12px;
      color: #6c757d;
      margin-left: 8px;
    }
    .nats-inline-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
  </style>

  <div class="nats-server-config">
    
    <!-- Connection -->
    <div class="nats-section">
      <div class="nats-section-header">
        <div class="nats-section-title">
          <i class="fa fa-server"></i>
          <span>Connection</span>
        </div>
        <i class="fa fa-chevron-down nats-section-toggle"></i>
      </div>
      <div class="nats-section-content">
        <div class="nats-form-row">
          <label><i class="fa fa-link"></i>NATS Server URL</label>
          <input type="text" id="node-config-input-server" placeholder="nats://localhost:4222">
          <div class="nats-hint">
            Examples: <code>nats://localhost:4222</code>, <code>nats://server1:4222,nats://server2:4222</code>
          </div>
        </div>
        
        <div class="nats-checkbox-row">
          <input type="checkbox" id="node-config-input-debug">
          <label for="node-config-input-debug"><i class="fa fa-bug"></i>Enable Debug Logging</label>
        </div>
      </div>
    </div>
    
    <!-- Security & Authentication -->
    <div class="nats-section">
      <div class="nats-section-header">
        <div class="nats-section-title">
          <i class="fa fa-shield"></i>
          <span>Security & Authentication</span>
        </div>
        <i class="fa fa-chevron-down nats-section-toggle"></i>
      </div>
      <div class="nats-section-content">
        <div class="nats-form-row">
          <label><i class="fa fa-key"></i>Authentication Method</label>
          <select id="node-config-input-authMethod">
            <option value="none">No Authentication</option>
            <option value="userpass">Username / Password</option>
            <option value="token">Token</option>
            <option value="jwt">JWT + NKey</option>
            <option value="nkey">NKey Only</option>
          </select>
        </div>
        
        <!-- Username/Password -->
        <div id="auth-userpass-section" class="nats-auth-section">
          <div class="nats-grid">
            <div class="nats-form-row">
              <label><i class="fa fa-user"></i>Username</label>
              <input type="text" id="node-config-input-user" placeholder="Username">
            </div>
            <div class="nats-form-row">
              <label><i class="fa fa-lock"></i>Password</label>
              <input type="password" id="node-config-input-pass" placeholder="Password">
            </div>
          </div>
        </div>
        
        <!-- Token -->
        <div id="auth-token-section" class="nats-auth-section">
          <div class="nats-form-row">
            <label><i class="fa fa-ticket"></i>Authentication Token</label>
            <input type="password" id="node-config-input-token" placeholder="Token">
          </div>
        </div>
        
        <!-- JWT -->
        <div id="auth-jwt-section" class="nats-auth-section">
          <div class="nats-form-row">
            <label><i class="fa fa-certificate"></i>JWT Token</label>
            <textarea id="node-config-input-jwt" rows="3" placeholder="Paste JWT here..."></textarea>
          </div>
          <div class="nats-form-row">
            <label><i class="fa fa-fingerprint"></i>NKey Seed</label>
            <textarea id="node-config-input-nkeySeed" rows="2" placeholder="Paste NKey seed here..."></textarea>
          </div>
        </div>
        
        <!-- NKey Only -->
        <div id="auth-nkey-section" class="nats-auth-section">
          <div class="nats-form-row">
            <label><i class="fa fa-fingerprint"></i>NKey Seed</label>
            <textarea id="node-config-input-nkeySeed" rows="2" placeholder="Paste NKey seed here..."></textarea>
          </div>
        </div>
        
        <!-- TLS -->
        <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid #e9ecef;">
          <div class="nats-checkbox-row">
            <input type="checkbox" id="node-config-input-enableTLS">
            <label for="node-config-input-enableTLS"><i class="fa fa-lock"></i>Enable TLS/SSL Encryption</label>
          </div>
          
          <div id="tls-config-section" style="display: none; margin-top: 12px;">
            <div class="nats-form-row">
              <label><i class="fa fa-certificate"></i>CA Certificate Path</label>
              <input type="text" id="node-config-input-tlsCaFile" placeholder="/path/to/ca.crt (optional)">
            </div>
            <div class="nats-grid">
              <div class="nats-form-row">
                <label><i class="fa fa-file-text-o"></i>Client Certificate</label>
                <input type="text" id="node-config-input-tlsCertFile" placeholder="/path/to/client.crt">
              </div>
              <div class="nats-form-row">
                <label><i class="fa fa-key"></i>Client Key</label>
                <input type="text" id="node-config-input-tlsKeyFile" placeholder="/path/to/client.key">
              </div>
            </div>
            <div class="nats-checkbox-row">
              <input type="checkbox" id="node-config-input-tlsRejectUnauthorized" checked>
              <label for="node-config-input-tlsRejectUnauthorized"><i class="fa fa-check-circle"></i>Verify Server Certificate</label>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Connection Settings -->
    <div class="nats-section">
      <div class="nats-section-header">
        <div class="nats-section-title">
          <i class="fa fa-cogs"></i>
          <span>Advanced Settings</span>
        </div>
        <i class="fa fa-chevron-down nats-section-toggle"></i>
      </div>
      <div class="nats-section-content">
        <div class="nats-grid">
          <div class="nats-form-row">
            <label><i class="fa fa-refresh"></i>Max Reconnect Attempts</label>
            <div class="nats-inline-row">
              <input type="number" id="node-config-input-maxReconnectAttempts" min="1" max="100" placeholder="10">
            </div>
          </div>
          <div class="nats-form-row">
            <label><i class="fa fa-clock-o"></i>Reconnect Wait</label>
            <div class="nats-inline-row">
              <input type="number" id="node-config-input-reconnectTimeWait" min="100" max="60000" placeholder="1000">
              <span class="nats-unit">ms</span>
            </div>
          </div>
          <div class="nats-form-row">
            <label><i class="fa fa-hourglass"></i>Connection Timeout</label>
            <div class="nats-inline-row">
              <input type="number" id="node-config-input-timeout" min="1000" max="60000" placeholder="10000">
              <span class="nats-unit">ms</span>
            </div>
          </div>
          <div class="nats-form-row">
            <label><i class="fa fa-heartbeat"></i>Ping Interval</label>
            <div class="nats-inline-row">
              <input type="number" id="node-config-input-pingInterval" min="5000" max="120000" placeholder="30000">
              <span class="nats-unit">ms</span>
            </div>
          </div>
        </div>
        <div class="nats-form-row">
          <label><i class="fa fa-exclamation-triangle"></i>Max Ping Outs</label>
          <div class="nats-inline-row">
            <input type="number" id="node-config-input-maxPingOut" min="1" max="10" placeholder="3">
            <span class="nats-hint" style="margin: 0;">before disconnect</span>
          </div>
        </div>
      </div>
    </div>
    
  </div>
</script>

<script type="text/x-red" data-help-name="nats-suite-server">
  <p>Configures a connection to a NATS server.</p>

  <h3>Connection URL</h3>
  <p>Examples:</p>
  <ul>
    <li><code>nats://localhost:4222</code> - Local server</li>
    <li><code>nats://server1:4222,nats://server2:4222</code> - Cluster</li>
  </ul>

  <h3>Authentication</h3>
  <ul>
    <li><strong>None:</strong> No authentication</li>
    <li><strong>Username/Password:</strong> Basic auth</li>
    <li><strong>Token:</strong> Single token</li>
    <li><strong>JWT + NKey:</strong> NATS 2.x authentication</li>
    <li><strong>NKey:</strong> Cryptographic auth</li>
  </ul>

  <h3>TLS/SSL</h3>
  <p>Enable TLS for encrypted connections. For mutual TLS (mTLS), provide client certificate and key.</p>

  <h3>Reconnection</h3>
  <p>Automatic exponential backoff: 5s → 10s → 20s → 40s → 60s (max)</p>
</script>
