services:
  nodered:
    image: nodered/node-red:latest
    container_name: nodered-dev
    user: "1000:1000"  # Node-RED runs as UID 1000
    ports:
      - '1885:1880'
      - '4223:4223' # Expose embedded NATS server port
      - '1884:1884' # Embedded NATS MQTT port
      - '8223:8223' # Embedded NATS HTTP monitoring
      - '8080:8080' # Embedded NATS WebSocket port
    volumes:
      - ./node-red:/data
      - ./:/data/node_modules/node-red-contrib-nats-suite
      - ./config/certs:/data/certs:ro
      - ./config/nats-embedded.conf:/data/nats-embedded.conf:ro  # Custom NATS config for embedded server
      - ./bin:/data/bin:ro  # Custom NATS binaries (nats-server-linux-amd64, nats-server-linux-arm64)
    environment:
      - TZ=Europe/Berlin
    depends_on:
      - nats-server
    restart: unless-stopped

  nats-server:
    image: nats:latest
    container_name: nats-server-dev
    ports:
      - '4222:4222'  # NATS Client connections
      - '1883:1883'  # MQTT connections
      - '8222:8222'  # HTTP monitoring
      - '6222:6222'  # Cluster routing
    command:
      - "-c"
      - "/etc/nats/nats-server.conf"
    volumes:
      - ./config/nats-server.conf:/etc/nats/nats-server.conf:ro
      - nats-data:/data           # Persistent JetStream storage
      - ./config/certs:/etc/nats/certs:ro
    restart: unless-stopped


  nui:
    image: ghcr.io/nats-nui/nui:latest
    container_name: nui-dev
    ports:
      - '31311:31311'
    environment:
      - NUI_NATS_URL=nats://nats-server:4222
    depends_on:
      - nats-server
    restart: unless-stopped



volumes:
  nats-data:
 